# KTV点歌管理系统 开发手册
#### Author nyaachen
#### All Right Preserved

## 目录

1. 点歌系统整体介绍
- 点歌系统功能分析与抽象
- 点歌系统模块设计与分析
- 点歌系统关键算法


## 点歌系统整体介绍

本次试验要求完成一个KTV点歌管理系统，实现对用户和管理员的两个用户角色的服务。

启动点歌系统，进入登录界面， 提供对用户和管理员的登录接口。管理员登陆需要口令验证，用户可以直接登录。  
管理员登陆后可以查看系统中所有歌曲的信息，对歌曲进行添加、删除、重排序，也可以修改自己的登录密码。  
用户界面可以查看所有歌曲、用不同方法点歌、查看已点歌曲、切歌，还可以为歌曲评分。  
以上为基本要求，可扩展更多功能。

## 点歌系统功能分析与抽象

容易发现，整个项目的核心就在于以合适的方式管理歌曲信息。因此作为项目的核心，数据库管理系统是必不可少的项目。整个系统就是不断的管理数据库并与用户进行交互。  
由于用户交互的复杂性和交互设备的多变性，用户交互界面通常与整个系统分离设计。  
考虑到项目的背景，我们额外增加了一个播放器系统，支持系统的扩展性，方便日后的功能拓展。

于是，整个点歌系统分为三大子系统：歌曲信息数据库管理子系统、音乐播放器子系统、用户交互子系统。  
在程序模块间逻辑上，用户交互系统直接与用户界面进行交互，同时将用户交互的结果通过统一的接口传递到数据库系统，而数据库系统将操作结果回传给用户交互系统。数据库系统根据需要，与播放器系统进行信息传递。

![系统模块划分图]

## 点歌系统模块设计与分析


在整个系统内，最重要的实体是歌曲，它具有多个属性，其中有一些是歌曲固有的，另一些是系统赋予的。

| 歌曲固有的属性 | 歌曲额外的属性 |
| :------------: | :------------: |
|     歌曲名     |   歌曲标识ID   |
|     歌手名     | 歌曲的播放状态 |
|    歌曲拼音    |  歌曲播放次数  |
|                |    评分次数    |
|                |    评分总和    |

一首歌曲可以由它的三个固有属性唯一确定，额外属性是系统中的歌曲所独有的内部特征。因此，一个歌曲的抽象逻辑表示是一个多元组，而定义在其上的功能是访问、排序、检索。

| 歌曲的基本操作 |  输入描述  |        输出描述        |
| :------------: | :--------: | :--------------------: |
|   歌曲的访问   |  属性键名  |        对应的值        |
|   歌曲的检索   |    曲名    |        是否检索        |
|                |   歌手名   |        是否检索        |
|                |  歌曲拼音  |        是否检索        |
|    歌曲排序    | 另一首歌曲 |   按评分是否在歌曲前   |
|                |            |  按播放量是否在歌曲前  |
|                |            | 按歌曲编号是否在歌曲前 |
|                |            |   按拼音是否在歌曲前   |
|                |            |      ~~按歌曲名~~      |
|                |            |      ~~按歌手名~~      |

###### 注：按中文拼音顺进行排序没有被实现。

---

数据表是数据库管理和保存的主要数据结构。作为一种成熟的数据抽象，数据表是一个广义表（二维度），但也可以理解为保存歌曲实体的线性表。其典型操作包括插入、删除、查找、排序、遍历等。

| 数据表的基本操作 |      输入描述       |    输出描述    |
| :--------------: | :-----------------: | :------------: |
|     歌曲检索     |   键值名、查找词    |  检索结果列表  |
|     歌曲插入     |      歌曲Song       | 插入是否成功TF |
|     歌曲删除     |          -          |       -        |
|     歌曲排序     | 排序依据的关键词key |  排序后的列表  |
|     歌曲遍历     |          -          |       -        |

---

数据透视表是在数据表之上的一种派生数据结构，它具有与数据表完全相同的操作，而它与数据表最大的区别就是透视表并不真正具有数据。对透视表的操作最终都会转化为对底层表的操作。透视表最大的作用就是保证数据的一致性。

---

数据库管理系统负责管理整个系统至关重要的数据管理功能。它维护着数据表和透视表，并对用户提供操作柄。每当操作柄对数据发生修改变化，数据库系统就将变化同步到文件中，防止潜在的数据丢失。

|  数据库管理系统的基本数据  |     基本操作     |      操作结果       |
| :------------------------: | :--------------: | :-----------------: |
| 歌曲数据总表、播放器透视表 |  获取用户操作柄  |  用户操作柄handler  |
|       各种临时透视表       | 获取管理员操作柄 | 管理员操作柄handler |
|       管理员密码数据       |    管理员登录    |          -          |
|                            |  管理员修改密码  |          -          |

---

操作柄是数据库管理系统对外接口的统一封装。通过操作柄操作数据库时，每当涉及数据库的写入，数据库管理系统就会收到通知，并对此做出响应。

---

播放器系统拥有一张独有的数据透视表，但与管理子系统不相同的是，它所抽象的是一个音乐播放器的播放列表和播放状态（尽管播放音乐这一具体动作并没有被真正的实现），也就是说，播放器维护的列表在数据结构角度更像是队列结构，其拥有的操作比较有限。

|   播放器系统的基本操作   | 输入描述 | 输出描述 |
| :----------------------: | :------: | :------: |
| 播放下一首歌曲（即切歌） |    -     |    -     |
|    向播放列表添加歌曲    | 歌曲Song |    -     |

---

用户交互系统负责在指定的交互设备上实现与用户的交互，读取用户的输入，通过操作柄传递给数据库管理系统，并将操作柄返回的结果输出到交互设备。

**用户交互系统的标准字符终端交互实现**

| 用户交互系统的主要功能 | 输入描述 | 输出描述 |
| :--------------------: | :------: | :------: |
|      启动欢迎屏幕      |    -     |    -     |
|    管理员交互-登录     |    -     |    -     |
|    用户交互-主菜单     |    -     |    -     |
... ...(下略)


## 点歌系统关键算法


## 点歌系统实现
考虑到歌曲属性有多种类型，为了统一接口，增强扩展性，我选择首先开发辅助类SongAttrib，用联合结构来表示歌曲的属性可能出现的整型、浮点型和字符型。于是我写好了代码：
```c++
union _song_attrib {
	std::string str;
	int i;
	double d;
};
```
写好单个模块后当然是编写一个测试用例run一遍，结果令人惊讶，预想的功能完全无法实现。![当场暴毙](dangchangbaobi.jpg)

	warning C4624: “KTV::song::_song_attrib”: 已将析构函数隐式定义为“已删除”
	error C2280: “KTV::song::_song_attrib::_song_attrib(const KTV::song::_song_attrib &)”: 尝试引用已删除的函数
>查阅*C++ Primer*后得知，在union结构体内本来是不能用含有定义了拷贝构造函数的类的；*C++11*标准取消了这一限制，但存在相应类类型对象的union类型会变得更加复杂。*C++ Primer*给出了一段示例代码，描述了使用辅助类结合匿名union来解决这一问题的方法，而这一代码与我在这一问题的原本解决思路不谋而合。

但经过理性的思考后，我选择了使用静态的类结构，通过牺牲空间来节约代码量，这是一种合理的实现——在这个例子中，保存的数据类型可以通过键值key唯一确定，因此实际上并不需要RTTI，我只需要一个能够存储多种数据类型的一个类就可以了，使用RTTI实现反而使系统变得复杂，毕竟这是线性表而不是广义表。

---

SongAttrib类的最终实现如下：
```c++
class SongAttrib
	SongAttrib(...)
		构造函数，可以传入int/double/string中的任何一种类型。
	getAttrib(...)
		传入一种类型的参数，返回该类型的元素的值。有常量和非常量版本。
		
```
有了SongAttrib类，就可以在此基础上构建歌曲Song类了。

---
Song类被实现为对标准库`std::map<SongAttrib>`类的派生。所有的歌曲操作都有函数与之对应。
| 歌曲的基本操作 |          对应的函数实现          |
| :------------: | :------------------------------: |
|   歌曲的访问   |  `SongAttrib &operator[](str)`   |
|                |   `SongAttrib operator[](str)`   |
|   歌曲的检索   |    `bool include_title(str)`     |
|                |    `bool include_artist(str)`    |
|                |    `bool include_pinyin(str)`    |
|    歌曲排序    |      `bool smaller_(Song)`       |
|                |    `bool smaller_rate(Song)`     |
|                | `bool smaller_playedtimes(Song)` |
|                |     `bool smaller_id(Song)`      |
|                |   `bool smaller_pinyin(Song)`    |